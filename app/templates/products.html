{% extends "base.html" %}

{% block title %}Products{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-8">
        <h2>Products</h2>
    </div>
    <div class="col-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
            + Add Product
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="productsTable">
                <thead>
                    <tr>
                        <th>SKU</th>
                        <th>Name</th>
                        <th>Stock</th>
                        <th>Cost Price</th>
                        <th>Selling Price</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsBody">
                    <!-- Filled by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addProductForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">SKU</label>
                        <input type="text" class="form-control" id="sku" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Cost Price</label>
                                <input type="number" class="form-control" id="cost_price" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Selling Price</label>
                                <input type="number" class="form-control" id="selling_price" step="0.01" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Stock Quantity</label>
                        <input type="number" class="form-control" id="current_stock" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Check login
if (!localStorage.getItem('token')) {
    window.location.href = '/login';
}

// Load products
async function loadProducts() {
    try {
        const products = await apiCall('GET', '/products');
        renderProducts(products);
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Render products table
function renderProducts(products) {
    const tbody = document.getElementById('productsBody');
    tbody.innerHTML = '';
    
    if (!products || products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    No products found. Add your first product.
                </td>
            </tr>
        `;
        return;
    }
    
    products.forEach(product => {
        const row = `
            <tr>
                <td>${product.sku}</td>
                <td>${product.name}</td>
                <td>
                    <span class="badge ${product.current_stock <= product.min_stock_level ? 'bg-warning' : 'bg-success'}">
                        ${product.current_stock}
                    </span>
                </td>
                <td>₹${product.cost_price}</td>
                <td>₹${product.selling_price}</td>
                <td>
                    <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                        ${product.is_active ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})">
                        Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                        Delete
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// Add product
document.getElementById('addProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productData = {
        sku: document.getElementById('sku').value,
        name: document.getElementById('name').value,
        cost_price: parseFloat(document.getElementById('cost_price').value),
        selling_price: parseFloat(document.getElementById('selling_price').value),
        current_stock: parseInt(document.getElementById('current_stock').value)
    };
    
    console.log('Adding product:', productData);

   const result = await fetch('/api/v1/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(productData)
        });
    
    // const result = await apiCall('POST', '/products', productData);
    
    if (result && result.id) {
        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
        document.getElementById('addProductForm').reset();
        
        // Reload products
        loadProducts();
        alert('Product added successfully!');
    }
});

// Delete product
async function deleteProduct(productId) {
    if (!confirm('Are you sure you want to delete this product?')) {
        return;
    }
    
    const result = await apiCall('DELETE', `/products/${productId}`);
    
    if (result) {
        loadProducts();
        alert('Product deleted successfully!');
    }
}

// Load products on page load
document.addEventListener('DOMContentLoaded', loadProducts);
</script>
{% endblock %}